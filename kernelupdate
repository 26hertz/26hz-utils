#!/bin/sh

export OLD_KVER=`uname -r`

eselect kernel list
echo -n "Select kernel set: "
read kselect
doas eselect kernel set ${kselect}

export NEW_KV=`echo ${kselect} | awk -F- '{ print $2 }'`
export NEW_KN=`echo ${kselect} | awk -F- '{ print $3 }'`

pushd /usr/src/linux > /dev/null || die
doas zcat /proc/config.gz > .config
doas make -j`nproc` && doas make modules_install && doas make install
popd > /dev/null || die

doas emerge -av @module-rebuild

doas genkernel initramfs --zfs --compress-initramfs --kernel-config=/usr/src/linux/.config --makeopts=-j`nproc`

doas cp /boot/loader/entries/gentoo-latest.conf /boot/loader/entries/gentoo-${OLD_KVER}.conf

doas tee /boot/loader/entries/gentoo-latest.conf <<EOF
title	Gentoo Linux ${NEW_KV}-${NEW_KN} (ZFS)
linux	/vmlinuz-${NEW_KV}-${NEW_KN}
initrd	/amd-uc.img
initrd	/initramfs-${NEW_KV}-${NEW_KN}.img
options root=ZFS=zroot/ROOT/gentoo rw dozfs=cache quiet init=/usr/lib/systemd/systemd nvidia-drm.modeset=1 amd_iommu=on iommu=pt loglevel=5 nowatchdog spectre_v1=off spectre_v2=off spec_store_bypass_disable=off pti=off
EOF
